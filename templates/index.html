<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomous Research Agent System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .research-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        .research-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .loading-spinner {
            display: none;
        }
        .citation-box {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 0.9em;
        }
        .citation-box {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 0.9em;
        }
        .gap-badge {
            font-size: 0.8em;
        }
        .paper-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: white;
        }
        .relevance-score {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .filter-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .search-bar {
            background: white;
            border: 2px solid #007bff;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
        }
        .search-bar:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
        }
        .filter-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .journal-filter-options {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .journal-filter-options.show {
            display: block;
        }
        .filter-stats {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-microscope"></i> Autonomous Research Agent System
            </span>
            <div>
                <a href="/literature" class="btn btn-outline-light me-2">
                    <i class="fas fa-book-open"></i> Literature Builder
                </a>
                <a href="/citations" class="btn btn-outline-light me-2">
                    <i class="fas fa-quote-right"></i> Enhanced Citations
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Research Input -->
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card research-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-search"></i> Start New Research
                        </h5>
                        <form id="researchForm">
                            <div class="mb-3">
                                <label for="topic" class="form-label">Research Topic</label>
                                <input type="text" class="form-control" id="topic" 
                                       placeholder="e.g., Machine Learning for Climate Change Prediction"
                                       required>
                                <div class="form-text">Enter any research topic you want to explore</div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-rocket"></i> Start Research
                            </button>
                        </form>
                        
                        <!-- Loading Spinner -->
                        <div class="loading-spinner text-center mt-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Researching...</span>
                            </div>
                            <p class="mt-2">Analyzing topic and searching for papers...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" style="display: none;">
            <!-- Comprehensive Filter Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="filter-section">
                        <h5 class="mb-4">
                            <i class="fas fa-filter"></i> Advanced Filters & Search
                        </h5>
                        
                        <!-- Search Bar -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="position-relative">
                                    <input type="text" class="search-bar" id="globalSearch" 
                                           placeholder="ðŸ” Search papers, authors, titles, journals, or any content...">
                                    <div class="position-absolute top-50 end-0 translate-middle-y me-3">
                                        <i class="fas fa-search text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filter Options -->
                        <div class="row">
                            <div class="col-md-3">
                                <div class="filter-card">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-journal-whills"></i> Journal Filter
                                    </label>
                                    <select class="form-select form-select-sm mb-2" id="journalFilter">
                                        <option value="">All Journals</option>
                                    </select>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="toggleJournalOptions()">
                                        <i class="fas fa-cog"></i> Advanced
                                    </button>
                                    
                                    <div class="journal-filter-options" id="journalOptions">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="journalMode" id="includeMode" value="include" checked>
                                            <label class="form-check-label" for="includeMode">
                                                <i class="fas fa-plus-circle text-success"></i> Include Only
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="journalMode" id="excludeMode" value="exclude">
                                            <label class="form-check-label" for="excludeMode">
                                                <i class="fas fa-minus-circle text-danger"></i> Exclude
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="multiJournalMode">
                                            <label class="form-check-label" for="multiJournalMode">
                                                <i class="fas fa-layer-group"></i> Multi-select Mode
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="filter-card">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-calendar"></i> Year Filter
                                    </label>
                                    <select class="form-select form-select-sm mb-2" id="yearFilter">
                                        <option value="">All Years</option>
                                    </select>
                                    <div class="row">
                                        <div class="col-6">
                                            <input type="number" class="form-control form-control-sm" id="yearFrom" placeholder="From">
                                        </div>
                                        <div class="col-6">
                                            <input type="number" class="form-control form-control-sm" id="yearTo" placeholder="To">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="filter-card">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-quote-right"></i> Citation Format
                                    </label>
                                    <select class="form-select form-select-sm mb-2" id="formatFilter">
                                        <option value="custom">Custom Format</option>
                                        <option value="bibtex">BibTeX</option>
                                        <option value="apa">APA</option>
                                        <option value="ieee">IEEE</option>
                                    </select>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showOnlyCitations">
                                        <label class="form-check-label" for="showOnlyCitations">
                                            Citations Only
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="filter-card">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-sliders-h"></i> Content Filter
                                    </label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showPapers" checked>
                                        <label class="form-check-label" for="showPapers">
                                            <i class="fas fa-file-alt"></i> Papers
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showCitations" checked>
                                        <label class="form-check-label" for="showCitations">
                                            <i class="fas fa-quote-right"></i> Citations
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showGaps" checked>
                                        <label class="form-check-label" for="showGaps">
                                            <i class="fas fa-lightbulb"></i> Research Gaps
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filter Stats and Actions -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="filter-stats">
                                    <span id="filterStats">Showing all results</span>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-outline-secondary me-2" onclick="clearAllFilters()">
                                    <i class="fas fa-times"></i> Clear All
                                </button>
                                <button class="btn btn-success me-2" onclick="downloadFilteredResults()">
                                    <i class="fas fa-download"></i> Download Filtered
                                </button>
                                <button class="btn btn-primary" onclick="saveFilterPreset()">
                                    <i class="fas fa-save"></i> Save Preset
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Summary -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-chart-bar"></i> Research Summary
                            </h5>
                            <div class="row" id="summaryStats">
                                <!-- Stats will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Topic Analysis -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-sitemap"></i> Topic Analysis
                            </h5>
                            <div id="topicAnalysis">
                                <!-- Topic analysis will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Papers Found -->
            <div class="row mt-4" id="papersRow">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-file-alt"></i> Papers Discovered
                                <span class="badge bg-primary ms-2" id="papersCount">0</span>
                            </h5>
                            <div id="papersSection">
                                <!-- Papers will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Citations -->
            <div class="row mt-4" id="citationsRow">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-quote-right"></i> Generated Citations
                                <span class="badge bg-primary ms-2" id="citationCount">0</span>
                            </h5>
                            
                            <div id="citationsSection">
                                <!-- Citations will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Research Gaps -->
            <div class="row mt-4" id="gapsRow">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-lightbulb"></i> Research Gaps Identified
                                <span class="badge bg-primary ms-2" id="gapsCount">0</span>
                            </h5>
                            <div id="gapsSection">
                                <!-- Research gaps will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-download"></i> Download Results
                            </h5>
                            <p>Download the complete research results as JSON file:</p>
                            <a id="downloadLink" class="btn btn-success" href="#" target="_blank">
                                <i class="fas fa-file-download"></i> Download JSON
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Research History -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-history"></i> Research History
                        </h5>
                        <div id="historySection">
                            <button class="btn btn-outline-primary" onclick="loadHistory()">
                                <i class="fas fa-refresh"></i> Load History
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log('JavaScript loading...'); // Debug log
        
        let currentResults = null;
        let allCitations = [];
        let filteredCitations = [];
        let allPapers = [];
        let filteredPapers = [];
        let allGaps = [];
        let filteredGaps = [];
        let selectedJournals = [];
        let journalMode = 'include';

        console.log('Variables initialized'); // Debug log

        document.getElementById('researchForm').addEventListener('submit', async function(e) {
            console.log('Form submitted!'); // Debug log
            e.preventDefault();
            
            const topic = document.getElementById('topic').value.trim();
            console.log('Topic:', topic); // Debug log
            if (!topic) return;
            
            console.log('Starting research request...'); // Debug log
            
            // Show loading
            document.querySelector('.loading-spinner').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            try {
                console.log('Sending fetch request...'); // Debug log
                const response = await fetch('/research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ topic: topic })
                });
                
                console.log('Response received:', response.status); // Debug log
                const data = await response.json();
                console.log('Data parsed:', data); // Debug log
                
                if (response.ok) {
                    console.log('Research successful, displaying results...'); // Debug log
                    currentResults = data;
                    allCitations = data.citations || [];
                    allPapers = data.papers || [];
                    allGaps = data.research_gaps || [];
                    
                    // Initialize filtered arrays
                    filteredCitations = [...allCitations];
                    filteredPapers = [...allPapers];
                    filteredGaps = [...allGaps];
                    
                    displayResults(data);
                    setupFilters();
                } else {
                    console.error('Research failed:', data.error); // Debug log
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Exception occurred:', error); // Debug log
                alert('Error: ' + error.message);
            } finally {
                document.querySelector('.loading-spinner').style.display = 'none';
            }
        });

        function displayResults(data) {
            // Show results section
            document.getElementById('results').style.display = 'block';
            
            // Summary stats
            const summaryHtml = `
                <div class="col-md-3">
                    <div class="text-center">
                        <h3 class="text-primary">${data.summary.papers_analyzed}</h3>
                        <small>Papers Analyzed</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h3 class="text-success">${data.summary.claims_extracted}</h3>
                        <small>Claims Extracted</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h3 class="text-warning">${data.summary.contradictions_found}</h3>
                        <small>Contradictions Found</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h3 class="text-info">${data.summary.research_gaps_identified}</h3>
                        <small>Research Gaps</small>
                    </div>
                </div>
            `;
            document.getElementById('summaryStats').innerHTML = summaryHtml;
            
            // Topic analysis
            const topicHtml = `
                <h6><strong>Main Topic:</strong> ${data.topic_map.main_topic}</h6>
                <p><strong>Subtopics:</strong> ${data.topic_map.subtopics.slice(0, 5).join(', ')}</p>
                <p><strong>Methods:</strong> ${data.topic_map.methods.join(', ')}</p>
                <p><strong>Keywords:</strong> ${data.topic_map.keywords.slice(0, 10).join(', ')}</p>
            `;
            document.getElementById('topicAnalysis').innerHTML = topicHtml;
            
            // Display all sections
            displayPapers();
            displayCitations();
            displayResearchGaps();
            
            // Download link
            if (data.download_url) {
                document.getElementById('downloadLink').href = data.download_url;
            }
            
            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function setupFilters() {
            if (!currentResults) return;
            
            // Get unique values for filters
            const journals = [...new Set([
                ...allPapers.map(p => p.venue),
                ...allCitations.map(c => c.journal_name)
            ])].filter(j => j).sort();
            
            const years = [...new Set([
                ...allPapers.map(p => p.year),
                ...allCitations.map(c => c.year)
            ])].filter(y => y).sort((a, b) => b - a);
            
            // Populate journal filter
            const journalFilter = document.getElementById('journalFilter');
            journalFilter.innerHTML = '<option value="">All Journals</option>';
            journals.forEach(journal => {
                const option = document.createElement('option');
                option.value = journal;
                option.textContent = journal;
                journalFilter.appendChild(option);
            });
            
            // Populate year filter
            const yearFilter = document.getElementById('yearFilter');
            yearFilter.innerHTML = '<option value="">All Years</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            
            // Set up event listeners
            document.getElementById('globalSearch').addEventListener('input', applyAllFilters);
            document.getElementById('journalFilter').addEventListener('change', applyAllFilters);
            document.getElementById('yearFilter').addEventListener('change', applyAllFilters);
            document.getElementById('yearFrom').addEventListener('input', applyAllFilters);
            document.getElementById('yearTo').addEventListener('input', applyAllFilters);
            document.getElementById('formatFilter').addEventListener('change', displayCitations);
            document.getElementById('showPapers').addEventListener('change', toggleContentVisibility);
            document.getElementById('showCitations').addEventListener('change', toggleContentVisibility);
            document.getElementById('showGaps').addEventListener('change', toggleContentVisibility);
            document.getElementById('showOnlyCitations').addEventListener('change', toggleContentVisibility);
            
            // Journal mode radio buttons
            document.querySelectorAll('input[name="journalMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    journalMode = this.value;
                    applyAllFilters();
                });
            });
            
            updateFilterStats();
        }

        function applyAllFilters() {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
            const selectedJournal = document.getElementById('journalFilter').value;
            const selectedYear = document.getElementById('yearFilter').value;
            const yearFrom = parseInt(document.getElementById('yearFrom').value) || null;
            const yearTo = parseInt(document.getElementById('yearTo').value) || null;
            
            // Filter papers
            filteredPapers = allPapers.filter(paper => {
                // Search filter
                if (searchTerm) {
                    const searchableText = [
                        paper.title,
                        paper.authors.join(' '),
                        paper.venue,
                        paper.abstract
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Journal filter
                if (selectedJournal) {
                    if (journalMode === 'include' && paper.venue !== selectedJournal) {
                        return false;
                    } else if (journalMode === 'exclude' && paper.venue === selectedJournal) {
                        return false;
                    }
                }
                
                // Year filters
                if (selectedYear && paper.year.toString() !== selectedYear) {
                    return false;
                }
                
                if (yearFrom && paper.year < yearFrom) {
                    return false;
                }
                
                if (yearTo && paper.year > yearTo) {
                    return false;
                }
                
                return true;
            });
            
            // Filter citations
            filteredCitations = allCitations.filter(citation => {
                // Search filter
                if (searchTerm) {
                    const searchableText = [
                        citation.bibtex,
                        citation.apa,
                        citation.ieee,
                        citation.custom_format,
                        citation.journal_name
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Journal filter
                if (selectedJournal) {
                    if (journalMode === 'include' && citation.journal_name !== selectedJournal) {
                        return false;
                    } else if (journalMode === 'exclude' && citation.journal_name === selectedJournal) {
                        return false;
                    }
                }
                
                // Year filters
                if (selectedYear && citation.year.toString() !== selectedYear) {
                    return false;
                }
                
                if (yearFrom && citation.year < yearFrom) {
                    return false;
                }
                
                if (yearTo && citation.year > yearTo) {
                    return false;
                }
                
                return true;
            });
            
            // Filter research gaps
            filteredGaps = allGaps.filter(gap => {
                if (searchTerm) {
                    const searchableText = [
                        gap.description,
                        gap.type,
                        ...(gap.potential_questions || [])
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Update displays
            displayPapers();
            displayCitations();
            displayResearchGaps();
            updateFilterStats();
        }

        function displayPapers() {
            document.getElementById('papersCount').textContent = filteredPapers.length;
            
            if (filteredPapers.length === 0) {
                document.getElementById('papersSection').innerHTML = '<p class="text-muted">No papers match the current filters.</p>';
                return;
            }
            
            const papersHtml = filteredPapers.map(paper => `
                <div class="paper-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-2">${paper.title}</h6>
                            <p class="text-muted mb-1">
                                <strong>Authors:</strong> ${paper.authors.join(', ')}
                            </p>
                            <p class="text-muted mb-2">
                                <strong>Year:</strong> ${paper.year} | 
                                <strong>Venue:</strong> ${paper.venue}
                            </p>
                            <p class="small">${paper.abstract}</p>
                            ${paper.doi || paper.url ? `
                                <div class="mt-2">
                                    <a href="${paper.doi ? (paper.doi.startsWith('http') ? paper.doi : 'https://doi.org/' + paper.doi) : paper.url}" 
                                       target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-external-link-alt"></i> View Paper
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                        <span class="relevance-score ms-3">
                            ${(paper.relevance_score * 100).toFixed(0)}%
                        </span>
                    </div>
                </div>
            `).join('');
            document.getElementById('papersSection').innerHTML = papersHtml;
        }

        function displayResearchGaps() {
            document.getElementById('gapsCount').textContent = filteredGaps.length;
            
            if (filteredGaps.length === 0) {
                document.getElementById('gapsSection').innerHTML = '<p class="text-muted">No research gaps match the current filters.</p>';
                return;
            }
            
            const gapsHtml = filteredGaps.slice(0, 10).map(gap => `
                <div class="mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6>${gap.description}</h6>
                            <span class="badge bg-secondary gap-badge">${gap.type}</span>
                        </div>
                        <span class="badge bg-primary">
                            Priority: ${(gap.priority * 100).toFixed(0)}%
                        </span>
                    </div>
                    ${gap.potential_questions && gap.potential_questions.length > 0 ? 
                        `<div class="mt-2">
                            <small><strong>Potential Questions:</strong></small>
                            <ul class="small mt-1">
                                ${gap.potential_questions.slice(0, 2).map(q => `<li>${q}</li>`).join('')}
                            </ul>
                        </div>` : ''
                    }
                </div>
            `).join('');
            document.getElementById('gapsSection').innerHTML = gapsHtml;
        }

        function toggleContentVisibility() {
            const showPapers = document.getElementById('showPapers').checked;
            const showCitations = document.getElementById('showCitations').checked;
            const showGaps = document.getElementById('showGaps').checked;
            const showOnlyCitations = document.getElementById('showOnlyCitations').checked;
            
            // Toggle section visibility
            document.getElementById('papersRow').style.display = showPapers && !showOnlyCitations ? 'block' : 'none';
            document.getElementById('citationsRow').style.display = showCitations ? 'block' : 'none';
            document.getElementById('gapsRow').style.display = showGaps && !showOnlyCitations ? 'block' : 'none';
            
            updateFilterStats();
        }

        function toggleJournalOptions() {
            const options = document.getElementById('journalOptions');
            options.classList.toggle('show');
        }

        function updateFilterStats() {
            const totalPapers = allPapers.length;
            const totalCitations = allCitations.length;
            const totalGaps = allGaps.length;
            
            const filteredPapersCount = filteredPapers.length;
            const filteredCitationsCount = filteredCitations.length;
            const filteredGapsCount = filteredGaps.length;
            
            const statsText = `Showing ${filteredPapersCount}/${totalPapers} papers, ${filteredCitationsCount}/${totalCitations} citations, ${filteredGapsCount}/${totalGaps} gaps`;
            document.getElementById('filterStats').textContent = statsText;
        }

        function clearAllFilters() {
            // Clear all filter inputs
            document.getElementById('globalSearch').value = '';
            document.getElementById('journalFilter').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('yearFrom').value = '';
            document.getElementById('yearTo').value = '';
            document.getElementById('formatFilter').value = 'custom';
            
            // Reset checkboxes
            document.getElementById('showPapers').checked = true;
            document.getElementById('showCitations').checked = true;
            document.getElementById('showGaps').checked = true;
            document.getElementById('showOnlyCitations').checked = false;
            
            // Reset journal mode
            document.getElementById('includeMode').checked = true;
            journalMode = 'include';
            
            // Reset filtered arrays
            filteredPapers = [...allPapers];
            filteredCitations = [...allCitations];
            filteredGaps = [...allGaps];
            
            // Update displays
            displayPapers();
            displayCitations();
            displayResearchGaps();
            toggleContentVisibility();
            updateFilterStats();
        }

        function downloadFilteredResults() {
            if (!currentResults) {
                alert('No results to download.');
                return;
            }
            
            const format = document.getElementById('formatFilter').value;
            const showOnlyCitations = document.getElementById('showOnlyCitations').checked;
            
            let content = '';
            let filename = '';
            
            if (showOnlyCitations) {
                // Download only citations
                if (filteredCitations.length === 0) {
                    alert('No citations to download. Please adjust your filters.');
                    return;
                }
                
                if (format === 'custom') {
                    content = '\\begin{thebibliography}{99}\n\n';
                    filteredCitations.forEach(citation => {
                        content += (citation.custom_format || citation.bibtex) + '\n\n';
                    });
                    content += '\\end{thebibliography}';
                    filename = `citations_${format}_${new Date().toISOString().split('T')[0]}.tex`;
                } else {
                    filteredCitations.forEach(citation => {
                        content += getCitationText(citation, format) + '\n\n';
                    });
                    filename = `citations_${format}_${new Date().toISOString().split('T')[0]}.txt`;
                }
            } else {
                // Download complete filtered results
                const filteredResults = {
                    ...currentResults,
                    papers: filteredPapers,
                    citations: filteredCitations,
                    research_gaps: filteredGaps,
                    filter_applied: {
                        search_term: document.getElementById('globalSearch').value,
                        journal: document.getElementById('journalFilter').value,
                        year: document.getElementById('yearFilter').value,
                        year_range: {
                            from: document.getElementById('yearFrom').value,
                            to: document.getElementById('yearTo').value
                        },
                        journal_mode: journalMode
                    }
                };
                
                content = JSON.stringify(filteredResults, null, 2);
                filename = `filtered_research_${new Date().toISOString().split('T')[0]}.json`;
            }
            
            downloadFile(content, filename);
        }

        function saveFilterPreset() {
            const preset = {
                search_term: document.getElementById('globalSearch').value,
                journal: document.getElementById('journalFilter').value,
                year: document.getElementById('yearFilter').value,
                year_from: document.getElementById('yearFrom').value,
                year_to: document.getElementById('yearTo').value,
                format: document.getElementById('formatFilter').value,
                show_papers: document.getElementById('showPapers').checked,
                show_citations: document.getElementById('showCitations').checked,
                show_gaps: document.getElementById('showGaps').checked,
                show_only_citations: document.getElementById('showOnlyCitations').checked,
                journal_mode: journalMode
            };
            
            const presetName = prompt('Enter a name for this filter preset:');
            if (presetName) {
                localStorage.setItem(`filter_preset_${presetName}`, JSON.stringify(preset));
                alert(`Filter preset "${presetName}" saved successfully!`);
            }
        }

        function displayCitations() {
            const format = document.getElementById('formatFilter').value;
            document.getElementById('citationCount').textContent = filteredCitations.length;
            
            if (filteredCitations.length === 0) {
                document.getElementById('citationsSection').innerHTML = '<p class="text-muted">No citations match the current filters.</p>';
                return;
            }
            
            const citationsHtml = filteredCitations.map((citation, index) => `
                <div class="mb-4 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="badge bg-primary me-2">${citation.journal_name}</span>
                            <span class="badge bg-success">${citation.year}</span>
                        </div>
                        <div>
                            ${citation.paper_url ? `
                                <a href="${citation.paper_url}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                                    <i class="fas fa-external-link-alt"></i> View Paper
                                </a>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyCitation(${index})">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                    
                    <div class="citation-box">
                        ${getCitationText(citation, format)}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('citationsSection').innerHTML = citationsHtml;
        }

        function getCitationText(citation, format) {
            switch(format) {
                case 'bibtex':
                    return citation.bibtex;
                case 'apa':
                    return citation.apa;
                case 'ieee':
                    return citation.ieee;
                case 'custom':
                    return citation.custom_format || citation.bibtex;
                default:
                    return citation.bibtex;
            }
        }

        function copyCitation(index) {
            const citation = filteredCitations[index];
            const format = document.getElementById('formatFilter').value;
            const text = getCitationText(citation, format);
            
            navigator.clipboard.writeText(text).then(() => {
                // Show success feedback
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.add('btn-success');
                button.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 2000);
            });
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        async function loadHistory() {
            try {
                const response = await fetch('/history');
                const files = await response.json();
                
                if (files.length === 0) {
                    document.getElementById('historySection').innerHTML = '<p class="text-muted">No previous research found.</p>';
                    return;
                }
                
                const historyHtml = files.map(file => `
                    <div class="border rounded p-3 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${file.topic}</h6>
                                <small class="text-muted">
                                    ${new Date(file.generated_at).toLocaleString()} | 
                                    ${file.papers_count} papers, ${file.claims_count} claims
                                </small>
                            </div>
                            <a href="${file.download_url}" class="btn btn-sm btn-outline-primary" target="_blank">
                                <i class="fas fa-download"></i> Download
                            </a>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('historySection').innerHTML = historyHtml;
                
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }
    </script>
</body>
</html>